<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Predicted Runway</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.js"
          integrity="sha512-n/4gHW3atM3QqRcbCn6ewmpxcLAHGaDjpEBu4xZd47N0W2oQ+6q7oc3PXstrJYXcbNU1OHdQ1T7pAP+gi5Yu8g=="
          crossorigin="anonymous" referrerpolicy="no-referrer">
  </script>
      <!-- Include Moment.js CDN -->
  <script type="text/javascript"
          src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment.min.js">
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
          crossorigin="anonymous">
  </script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css"
        integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x"
        rel="stylesheet"
        crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link rel="stylesheet"
          href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
          integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
            integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
            crossorigin="">
    </script>
</head>
<body>
  <nav class="navbar navbar-expand-lg sticky-top navbar-dark bg-dark" style="width: 100%">
    <div class="container">
      <a class="navbar-brand"  href="{{ url_for('web.index') }}">Predicted Runway</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
      <div class="collapse navbar-collapse" id="navbarNavDropdown">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item dropdown">
              <a class="btn btn-primary" href="#newPredictionForm" role="button" data-bs-toggle="modal" aria-expanded="false">
                New prediction
              </a>
            </li>
          </ul>
        <div class="d-flex">
            {% block modelInfo %}
            {% endblock %}
        </div>
      </div>
    </div>
  </nav>

  <div class="modal fade" id="newPredictionForm" aria-hidden="true" aria-labelledby="predictionForm" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="predictionForm">New Runway Prediction</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

          <div class="modal-body">
            <div class="form-group">
            <div class="mb-3">

              <label for="originAirports" class="form-label">Departing from</label>
              <input autoComplete="off"
                     class="form-control"
                     list="originAirportOptions"
                     id="originIcaoListItem"
                     name="originIcaoListItem"
                     placeholder="Type to search"
                     onkeyup="updateOriginAirports()"
                     onchange="originAirportSelected()">
              <datalist id="originAirportOptions">
              </datalist>
              <input id="originIcao" type="text" hidden>
            </div>
            <div class="mb-3">
            <label for="destinationIcao" class="form-label">Arriving to</label>
                <select id="destinationIcao" class="form-control" onchange="destinationAirportSelected()">
                    <option value=" " label=""></option>
                  {% for icao, airport_data in destination_airports_data.items() %}
                    <option value="{{ airport_data['icao'] }}" label="{{ airport_data['label'] }}"></option>
                  {% endfor %}
                </select>
            </div>
            <div class="mb-3">
              <label for="dateTimeRange" class="form-label">Arriving at</label>
              <input type="range" class="form-range" min="0" max="0" id="dateTimeRange" value="0" onchange="sliderMoved()">
              <input type="text" id="timestamp" name="timestamp" hidden>
              <span id="dateTimeText"></span>
            </div>

            </div>
          </div>
        <div class="modal-footer">
          <div class="mb-3">
              <a class="btn btn-primary" id="formButton" role="button" href="" onclick="resetForm()">Predict</a>
          </div>
      </div>
    </div>
  </div>
  </div>

    <script>
      const $dateTimeRange = window.document.getElementById('dateTimeRange');
      const $timestamp = window.document.getElementById('timestamp');
      const $dateTimeText = window.document.getElementById('dateTimeText');
      const $originIcaoListItem = window.document.getElementById('originIcaoListItem');
      const $originIcao = window.document.getElementById('originIcao');
      const $destinationIcao = window.document.getElementById('destinationIcao');
      const $predictionForm = window.document.getElementById('predictionForm');
      const $originAirportOptions = window.document.getElementById('originAirportOptions');
      const $formButton = window.document.getElementById('formButton');

      function getCurrentTimestamp() {
        return Math.ceil(new Date().getTime() / 1000);
      }

      function originAirportSelected() {
        updateOriginIcao();
        updateFormButtonHref();
      }

      function sliderMoved() {
        updateCurrentTimestamp();
        updateFormButtonHref();
      }

      function updateOriginIcao() {
          $originIcao.value = $originIcaoListItem.value.slice(0, 4);
      }
      function updateCurrentTimestamp() {
        const startTimestamp = $dateTimeRange.getAttribute('data-start-timestamp');
        $timestamp.value = Number(startTimestamp) + (3600 * $dateTimeRange.value);
        $dateTimeText.innerHTML = `<strong>${moment(new Date($timestamp.value * 1000)).format('LLLL')}</strong>`;
      }

      function updateFormButtonHref() {
        const url = `{{ url_for('web.web_runway_prediction') }}`;

        $formButton.href = `${url}?destination_icao=${$destinationIcao.value}&origin_icao=${$originIcao.value}&timestamp=${$timestamp.value}`;
      }

      function resetForm() {
        $originIcaoListItem.value = '';
        $destinationIcao.value = ' ';
        $timestamp.value = '';
        $dateTimeRange.value = 0;
      }

      function destinationAirportSelected() {
          if ($destinationIcao.value !== " ") {
            updateTimestamps($destinationIcao.value);
            updateFormButtonHref();
          }
      }

      function updateOriginAirports() {
          $originAirportOptions.innerHTML = "";
          const search_value = $originIcaoListItem.value;

          if (search_value.length < 2) {
              return;
          }

          $.ajax({url: `/airports-data/${search_value}`, success: function(res){
              res.forEach((r) => {
                  const option = window.document.createElement('option');
                  option.label = r.label;
                  option.value = r.label;
                  $originAirportOptions.appendChild(option);
              });
          }});
      }

      function updateTimestamps(airport) {
          $.ajax({url: `/forecast-timestamp-range/${airport}`, success: function(res){
              const startDatetime = new Date();
              startDatetime.setMinutes(0);
              startDatetime.setSeconds(0);
              const startDateTimeTimestamp = Math.floor(startDatetime.getTime() / 1000);
              const dateTimeRangeMax = Math.floor(((res.end_timestamp - startDateTimeTimestamp) / 3600));

              $timestamp.value = startDateTimeTimestamp;
              $dateTimeRange.setAttribute('max', dateTimeRangeMax);
              $dateTimeRange.setAttribute('data-start-timestamp', startDateTimeTimestamp);
              updateCurrentTimestamp();
          }});
      }

    $( document ).ready(function() {

    });
    </script>
  {% block content %}
  {% endblock %}
</body>
</html>
