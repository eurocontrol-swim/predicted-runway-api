<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Predicted Runway</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.js"
          integrity="sha512-n/4gHW3atM3QqRcbCn6ewmpxcLAHGaDjpEBu4xZd47N0W2oQ+6q7oc3PXstrJYXcbNU1OHdQ1T7pAP+gi5Yu8g=="
          crossorigin="anonymous" referrerpolicy="no-referrer">
  </script>
      <!-- Include Moment.js CDN -->
  <script type="text/javascript"
          src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment.min.js">
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
          crossorigin="anonymous">
  </script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css"
        integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x"
        rel="stylesheet"
        crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link rel="stylesheet"
          href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
          integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
            integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
            crossorigin="">
    </script>
</head>
<body class="d-flex flex-column h-100">
  <nav class="navbar navbar-expand-lg sticky-top navbar-dark bg-dark" style="width: 100%">
    <div class="container">
      <a class="navbar-brand"  href="{{ url_for('web.index') }}">Predicted Runway</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
      <div class="collapse navbar-collapse" id="navbarNavDropdown">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" id="newPredictionMenu" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                New prediction
              </a>
              <ul class="dropdown-menu" aria-labelledby="newPredictionMenu">
                <li><a class="dropdown-item" data-bs-toggle="modal" href="#rpForm">Runway</a></li>
                <li><a class="dropdown-item" data-bs-toggle="modal" href="#rcpForm">Runway configuration</a></li>
              </ul>
            </li>
          </ul>
        <div class="d-flex">
            {% block modelStats %}
            {% endblock %}
        </div>
      </div>
    </div>
  </nav>

  <div class="modal fade" id="rpForm" aria-hidden="true" aria-labelledby="rpForm" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="rpForm">New Runway Prediction</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form method="POST" action="{{ url_for('web.runway_prediction') }}">
          <div class="modal-body">
            <div class="form-group">
            <div class="mb-3">

              <label for="rpOriginAirports" class="form-label">Departing from</label>
              <input autoComplete="off"
                     class="form-control"
                     list="rpOriginAirportOptions"
                     id="rpOriginIcaoListItem"
                     placeholder="Type to search"
                     onkeyup="updateRpOriginAirports()"
                     onchange="rpOriginAirportSelected()"
                     required
              >
              <datalist id="rpOriginAirportOptions">
              </datalist>
              <input id="rpOriginIcao" name="origin_icao" type="text" hidden required>
            </div>
            <div class="mb-3">
            <label for="rpDestinationIcao" class="form-label">Arriving to</label>
                <select id="rpDestinationIcao" name="destination_icao" class="form-control" required onchange="rpDestinationAirportSelected()">
                    <option value="" label=""></option>
                  {% for airport in destination_airports %}
                    <option value="{{ airport.icao }}" label="{{ airport.title }}"></option>
                  {% endfor %}
                </select>
            </div>
            <div class="mb-3">
              <label for="rpDateTimeRange" class="form-label">Arriving at</label>
              <input type="range" class="form-range" min="0" max="0" id="rpDateTimeRange" value="0" onchange="rpSliderMoved()" oninput="rpSliderMoved()">
              <input type="text" id="rpTimestamp" name="timestamp" hidden required>
              <span id="rpDateTimeText"></span>
            </div>
            </div>
          </div>
        <div class="modal-footer">
          <div class="mb-3">
              <button class="btn btn-primary" id="rpFormButton" type="submit">Predict</button>
          </div>
      </div>
        </form>
    </div>
  </div>
  </div>

  <div class="modal fade" id="rcpForm" aria-hidden="true" aria-labelledby="rcpForm" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="rcpForm">New Runway Configuration Prediction</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form method="POST" action="{{ url_for('web.runway_config_prediction') }}">
          <div class="modal-body">
            <div class="form-group">
            <div class="mb-3">
            <label for="rcpDestinationIcao" class="form-label">Arriving to</label>
                <select id="rcpDestinationIcao" name="destination_icao" class="form-control" required onchange="rcpDestinationAirportSelected()">
                    <option value="" label=""></option>
                  {% for airport in destination_airports %}
                    <option value="{{ airport.icao }}" label="{{ airport.title }}"></option>
                  {% endfor %}
                </select>
            </div>
            <div class="mb-3">
              <label for="rcpDateTimeRange" class="form-label">Arriving at</label>
              <input type="range" class="form-range" min="0" max="0" id="rcpDateTimeRange" value="0" onchange="rcpSliderMoved()" oninput="rcpSliderMoved()">
              <input type="text" id="rcpTimestamp" name="timestamp" hidden required>
              <span id="rcpDateTimeText"></span>
            </div>
            </div>
          </div>
        <div class="modal-footer">
          <div class="mb-3">
              <button class="btn btn-primary" id="rcpFormButton" type="submit">Predict</button>
          </div>
      </div>
        </form>
    </div>
  </div>
  </div>


    <script>
      const $rpDateTimeRange = window.document.getElementById('rpDateTimeRange');
      const $rpTimestamp = window.document.getElementById('rpTimestamp');
      const $rpDateTimeText = window.document.getElementById('rpDateTimeText');
      const $rpOriginIcaoListItem = window.document.getElementById('rpOriginIcaoListItem');
      const $rpOriginIcao = window.document.getElementById('rpOriginIcao');
      const $rpDestinationIcao = window.document.getElementById('rpDestinationIcao');
      const $rpForm = window.document.getElementById('rpForm');
      const $rpOriginAirportOptions = window.document.getElementById('rpOriginAirportOptions');

      const $rcpDateTimeRange = window.document.getElementById('rcpDateTimeRange');
      const $rcpTimestamp = window.document.getElementById('rcpTimestamp');
      const $rcpDateTimeText = window.document.getElementById('rcpDateTimeText');
      const $rcpOriginIcaoListItem = window.document.getElementById('rcpOriginIcaoListItem');
      const $rcpOriginIcao = window.document.getElementById('rcpOriginIcao');
      const $rcpDestinationIcao = window.document.getElementById('rcpDestinationIcao');
      const $rcpForm = window.document.getElementById('rcpForm');
      const $rcpOriginAirportOptions = window.document.getElementById('rcpOriginAirportOptions');

      function getCurrentTimestamp() {
        return Math.ceil(new Date().getTime() / 1000);
      }

      function rpOriginAirportSelected() {
        $rpOriginIcao.value = $rpOriginIcaoListItem.value.slice(0, 4);
      }

      function rpSliderMoved() {
        updateRpCurrentTimestamp();
      }

      function rcpSliderMoved() {
        updateRcpCurrentTimestamp();
      }

      function formatDate(d) {
        return d.toUTCString().replace('GMT', 'UTC');
      }

      function updateRpCurrentTimestamp() {
        const startTimestamp = $rpDateTimeRange.getAttribute('data-start-timestamp');
        $rpTimestamp.value = Number(startTimestamp) + (3600 * $rpDateTimeRange.value);
        $rpDateTimeText.innerHTML = `<strong>${formatDate(new Date($rpTimestamp.value * 1000))}</strong>`;
      }

      function updateRcpCurrentTimestamp() {
        const startTimestamp = $rcpDateTimeRange.getAttribute('data-start-timestamp');
        $rcpTimestamp.value = Number(startTimestamp) + (3600 * $rcpDateTimeRange.value);
        $rcpDateTimeText.innerHTML = `<strong>${formatDate(new Date($rcpTimestamp.value * 1000))}</strong>`;
      }

      function resetRpForm() {
        $rpOriginIcaoListItem.value = '';
        $rpDestinationIcao.value = ' ';
        $rpTimestamp.value = '';
        $rpDateTimeRange.value = 0;
      }

      function resetRcpForm() {
        $rcpDestinationIcao.value = ' ';
        $rcpTimestamp.value = '';
        $rcpDateTimeRange.value = 0;
      }

      function rpDestinationAirportSelected() {
          if ($rpDestinationIcao.value !== " ") {
            updateRpTimestamps($rpDestinationIcao.value);
          }
      }

      function rcpDestinationAirportSelected() {
          if ($rcpDestinationIcao.value !== " ") {
            updateRcpTimestamps($rcpDestinationIcao.value);
          }
      }

      function updateRpOriginAirports() {
          $rpOriginAirportOptions.innerHTML = "";
          const search_value = $rpOriginIcaoListItem.value;

          if (search_value.length < 2) {
              return;
          }

          $.ajax({url: `/airports-data/${search_value}`, success: function(res){
              res.forEach((r) => {
                  const option = window.document.createElement('option');
                  option.label = r.title;
                  option.value = r.title;
                  $rpOriginAirportOptions.appendChild(option);
              });
          }});
      }

      function updateRpTimestamps(airport) {
          $.ajax({url: `/forecast-timestamp-range/${airport}`, success: function(res){
              const startDatetime = moment().utc();
              startDatetime.set('minutes', 0);
              startDatetime.set('seconds', 0);
              const startDateTimeTimestamp = startDatetime.unix();
              const rpDateTimeRangeMax = Math.floor(((res.end_timestamp - startDateTimeTimestamp) / 3600));

              $rpTimestamp.value = startDateTimeTimestamp;
              $rpDateTimeRange.setAttribute('max', rpDateTimeRangeMax.toString());
              $rpDateTimeRange.setAttribute('data-start-timestamp', startDateTimeTimestamp.toString());
              updateRpCurrentTimestamp();
          }});
      }

      function updateRcpTimestamps(airport) {
          $.ajax({url: `/forecast-timestamp-range/${airport}`, success: function(res){
              const startDatetime = moment().utc();
              startDatetime.set('minutes', 0);
              startDatetime.set('seconds', 0);
              const startDateTimeTimestamp = startDatetime.unix();
              const rcpDateTimeRangeMax = Math.floor(((res.end_timestamp - startDateTimeTimestamp) / 3600));

              $rcpTimestamp.value = startDateTimeTimestamp;
              $rcpDateTimeRange.setAttribute('max', rcpDateTimeRangeMax.toString());
              $rcpDateTimeRange.setAttribute('data-start-timestamp', startDateTimeTimestamp.toString());
              updateRcpCurrentTimestamp();
          }});
      }

      $(document).ready( function() {
        resetRpForm();
        resetRcpForm();
      })
    </script>
  <main class="flex-shrink-0">

  <div class="container">
  {% block content %}
  {% endblock %}
      <div>
        <a class="openapi-link"
            href="/api/0.1/ui"
        >Predicted Runway API specifications</a>
      </div>
  </div>
  </main>
</body>
  <style>
      a.openapi-link {
          text-decoration: none;
          color: #0c63e4;
          margin-left: 20px;
          font-size: .8em;
      }
  </style>
</html>
